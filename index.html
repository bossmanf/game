<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Metal Trivia Challenge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load aggressive/angular fonts: Orbitron for titles, Inter for body -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Define the Speed Metal Aesthetic */
        :root {
            --metal-black: #111827; /* Tailwind gray-900 */
            --metal-gray: #374151;  /* Tailwind gray-700 */
            --electric-cyan: #00ffff;
            --electric-blue: #3b82f6;
        }

        body {
            background: url('https://www.greatmusichall.com/wp-content/uploads/2020/07/venue_main_image-5.png?fit=crop&w=1920&q=80') no-repeat center center 
            font-family: 'Inter', sans-serif;
            color: #d1d5db;
        }

        .title-font {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 5px var(--electric-cyan), 0 0 10px rgba(0, 255, 255, 0.5);
            letter-spacing: 0.1em;
        }

        .metal-card {
            background-color: #1f2937; /* Darker background for components */
            border: 2px solid var(--metal-gray);
            border-radius: 0; /* Sharp corners */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); /* Blue core glow */
            /* Aggressive look: subtle skew */
            transform: skew(-0.5deg);
            transition: transform 0.3s;
        }

        .metal-button {
            /* Aggressive, sharp styling */
            background-color: var(--electric-blue);
            color: var(--metal-black);
            font-weight: 800;
            letter-spacing: 0.08em;
            transition: all 0.2s ease-in-out;
            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); /* Angular cut */
            border: none;
        }

        .metal-button:hover:not(:disabled) {
            background-color: var(--electric-cyan);
            color: var(--metal-black);
            transform: scale(1.02);
            box-shadow: 0 0 8px var(--electric-cyan);
        }
        
        .disabled-button {
            background-color: #4b5563 !important;
            color: #d1d5db !important;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .panel-border {
            border-left: 3px solid var(--electric-cyan);
            border-right: 3px solid var(--electric-cyan);
        }

        /* SVG Icon for angular, fast look */
        .speed-icon {
            filter: drop-shadow(0 0 4px var(--electric-cyan));
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 md:p-8 flex flex-col items-center">

        <header class="mb-8 mt-4 text-center">
            <h1 class="title-font text-5xl md:text-7xl text-white pb-2 tracking-tight">
                <span class="text-electric-cyan">SPEED</span> METAL TRIVIA
            </h1>
            <p class="text-gray-400 mt-2 italic text-sm">Challenge the Machine. Maximize the Score.</p>
        </header>

        <div id="error-display" class="w-full max-w-4xl p-4 mb-4 bg-red-900/50 border border-red-500 text-red-300 rounded-lg text-center hidden">
          <p class="font-bold">SYSTEM FAILURE: <span id="error-message"></span></p>
        </div>

        <div id="game-container" class="w-full max-w-4xl">
            <div className="mx-auto w-11/12 md:w-2/3 mb-10 border-4 border-yellow-500 rounded-lg overflow-hidden shadow-xl">
                <img 
                    src="https://media.gettyimages.com/id/1363411424/photo/smiling-young-man-playing-an-acoustic-guitar.jpg?s=2048x2048&w=gi&k=20&c=z8m_ZT1x5gFEstoTfBIulNKpBzp6D-XAbbfA7b7e2B8="
                    alt="Habibi is the best" 
                    className="w-full h-auto object-cover"
                    onError={(e) => 'Error loading'
                />
            </div>
            <!-- Content will be rendered here by JavaScript -->
        </div>

    </div>

    <script>
        // Global Game State
        const game = {
            phase: 1,             // 1: Welcome, 2: Topic Selection, 3: Question
            score: 0,
            isLLMLoaded: false,
            isLoading: false,
            topics: [],
            currentTopic: '',
            questionData: null,   // {question, correctAnswer, wrongAnswers[]}
            selectedAnswer: null, // The answer the player clicked
            message: 'Initializing...',
            error: null
        };
        const appContainer = document.getElementById('game-container');
        const errorDisplay = document.getElementById('error-display');
        const errorMessageElement = document.getElementById('error-message');

        let llmInference = null;

        
        /**
         * Updates the global game state and re-renders the UI.
         */
        function updateState(newState) {
            Object.assign(game, newState);
            if (game.error) {
                errorMessageElement.textContent = game.error;
                errorDisplay.classList.remove('hidden');
                console.error("Game Error:", game.error);
            } else {
                errorDisplay.classList.add('hidden');
            }
            renderGame();
        }
        
        /**
         * Helper to create HTML elements dynamically.
         */
        function createElement(tag, classes, innerHTML = '') {
            const el = document.createElement(tag);
            el.className = classes;
            el.innerHTML = innerHTML;
            return el;
        }


        // --- Phase 1: Initialization ---

        /**
         * Simulates LLM Model Loading and checks API connectivity.
         */


        async function loadModel(){
            updateState({ message: 'SYSTEM: Loading Machine Core...', isLoading: true, error: null });

            try {
                const { CreateMLCEngine } = await import('https://esm.run/@mlc-ai/web-llm');

                const initProgressCallback = (initProgress) => {
                    console.log(initProgress);
                    updateState({ 
                    message: 'Loading model...',
                    isLoading: true
                    });
                }
                const MODEL_NAME = "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC"
                
                llmInference = CreateMLCEngine(
                    MODEL_NAME,
                    { initProgressCallback: initProgressCallback }, // engineConfig
                );
                updateState({ 
                    isLLMLoaded: true, 
                    message: 'CORE ONLINE. Ready to Challenge.', 
                    isLoading: false 
                });
                console.log(`WebLLM Model (${MODEL_NAME}) Loaded and ready for client-side inference.`);


            } catch (e) {
                console.error("Failed to initialize WebLLM or load model weights. Check WebGPU support.", e);
                updateState({ 
                    error: `Initialization Failure: ${e.message}. Check Network.`, 
                    message: 'FATAL ERROR.', 
                    isLoading: false 
                });
            }  
                
        }


        async function initializeLLM() {

            await new Promise(resolve => loadModel()); 
        }

        // --- Phase 2: Topic Selection ---

        /**
         * Calls LLM to generate two topics.
         */
        async function getTopics() {
            if (game.score >= 1000) return; // Win check

            updateState({ 
                isLoading: true, 
                currentTopic: '', 
                questionData: null, 
                selectedAnswer: null, 
                topics: [], 
                phase: 2,
                message: 'QUERYING SYSTEM for next target...'
            });


            try {

                console.log("Fetching topics from ./topics.txt...");
                const res = await fetch('./topics.txt');
                
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                
                // Fetch, split, trim, and filter in one chain
                arr = (await res.text())
                    .split('\n')
                    .map(t => t.trim())
                    .filter(t => t.length > 0);

                if (arr.length < 2) throw new Error("File contains less than 2 valid topics.");
                console.log(`Successfully loaded ${arr.length} topics.`);
                const length = arr.length;
                let index1 = Math.floor(Math.random() * length);
                let index2 = index1;
                
                while (index1 === index2) index2 = Math.floor(Math.random() * length);

                topics = [arr[index1], arr[index2]];

            } catch (error) {
                console.error("Failed to load topics. Using defaults.", error);
                // 'arr' remains 'defaultTopics' if the try block fails
            }
            try{
                if (topics.length >= 2) {
                    updateState({ 
                        topics: topics.slice(0, 2),
                        message: 'TARGETS IDENTIFIED. Select your challenge.',
                        isLoading: false
                    });
                } else {
                    throw new Error('LLM returned insufficient topics.');
                }
            }
            catch (e) {
                updateState({ 
                    error: `Topic Generation Error: ${e.message}`, 
                    message: 'SYSTEM ABORTED TOPIC GENERATION.',
                    isLoading: false
                });
            }
        }



        async function runLLM_API_Call(prompt, schemaName = "UNKNOWN_SCHEMA") {

            if (!llmInference) {
                throw new Error("LLM not initialized.");
            }

            // Append the mandatory instruction for strict JSON output

            const messages = [{ role: "user", content: prompt}];

            let fullResponseText = "";
            
            // 2. Call the chat.completions.create method with stream: true
            const stream = await llmInference.chat.completions.create({
                messages: messages,
                stream: true, // Enable streaming
                temperature: 0.3
            });

            // Process the streaming output
            for await (const chunk of stream) {
                const content = chunk.choices[0].delta.content;
                if (content) {
                    fullResponseText += content;
                }
            }
            
            // --- Start Robust JSON Cleaning & Parsing ---
            let jsonString = fullResponseText.trim();
            
            // 1. Find the first opening curly brace '{' (where JSON must begin)
            const firstBracketIndex = jsonString.indexOf('{');
            if (firstBracketIndex > -1) {
                jsonString = jsonString.substring(firstBracketIndex);
            } else {
                throw new Error(`LLM Output for ${schemaName} did not contain a JSON start bracket '{'.`);
            }

            // 2. Find the last closing curly brace '}' and aggressively truncate everything after it.
            let lastBracketIndex = jsonString.lastIndexOf('}');
            if (lastBracketIndex > -1) {
                // Keep everything up to and including the last '}'
                jsonString = jsonString.substring(0, lastBracketIndex + 1);
            }
            
            // 3. Remove trailing markdown fences (e.g., ```) if they exist
            if (jsonString.endsWith('```')) {
                jsonString = jsonString.substring(0, jsonString.lastIndexOf('```')).trim();
            }
            
            // 4. Final check for non-JSON characters
            while (jsonString.endsWith('.') || jsonString.endsWith('\n')) {
                jsonString = jsonString.slice(0, -1).trim();
            }            
            try {
                const result = JSON.parse(jsonString);
                
                return result;

            } catch (e) {
                console.error(`Failed to parse cleaned JSON string for ${schemaName}:`, jsonString, e); 
                throw new Error(`Failed to parse LLM output for ${schemaName}. Raw string was: ${fullResponseText}`);
            }
        }





        /**
         * Calls LLM to generate a question, correct answer, and 3 wrong answers.
         */
        async function inferenceLLM(topic) {
            updateState({ 
                isLoading: true, 
                currentTopic: topic, 
                questionData: null, 
                phase: 3, 
                message: `LOADING QUESTION on: ${topic.toUpperCase()}...` 
            });

            const systemPrompt = `Generate a challenging trivia question based on the topic: "${topic}". Provide one question, one correct answer, and three distinct wrong answers.`;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "question": { "type": "STRING" },
                    "wrongAnswers": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" }
                    },
                    "correctAnswer": { "type": "STRING" },
                },
            };

            try {
                this.updateReactState({ phase: 'loading', message: `Generating question on ${topic}...` });

                const parsedJson = await this.runLLM_API_Call(systemPrompt, responseSchema);
                if (parsed.question && parsed.correctAnswer && parsed.wrongAnswers && parsed.wrongAnswers.length === 3) {
                    updateState({ 
                        questionData: parsed,
                        message: 'COMMENCE ENGAGEMENT.',
                        isLoading: false
                    });
                } else {
                    throw new Error('LLM returned malformed question data.');
                }
            } catch (e) {
                updateState({ 
                    error: `Question Generation Error: ${e.message}`, 
                    message: 'QUERY FAILED. Returning to Topic Select.',
                    isLoading: false
                });
                // Go back to topic selection if question generation fails
                getTopics(); 
            }
        }

        // --- Phase 3: Answer Logic ---

        /**
         * Handles player answer selection and score update.
         */
        function handleAnswerSelect(answer) {
            if (game.selectedAnswer !== null || game.isLoading) return; 

            let newScore = game.score;
            let feedback = '';
            
            updateState({ selectedAnswer: answer });

            if (answer === game.questionData.correctAnswer) {
                newScore += 100;
                feedback = 'MAXIMUM EFFORT! +100 SCORE GAIN.';
            } else {
                newScore -= 50;
                feedback = 'DEFEAT! -50 SCORE LOSS. Correct Answer Displayed.';
            }

            updateState({ score: newScore, message: feedback });
            
            // Check win condition or prepare for next round
            if (newScore >= 1000) {
                setTimeout(() => updateState({ message: 'VICTORY ACHIEVED! MACHINE DEFEATED.' }), 2000);
            } else {
                setTimeout(() => getTopics(), 3000); // 3 second delay before next topic selection
            }
        }

        // --- UI Rendering ---
        
        function renderPhase1() {
            const welcomeContent = createElement('div', 'flex flex-col items-center justify-center h-full p-8');
            
            if (game.isLoading) {
                welcomeContent.innerHTML = `
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-electric-cyan border-gray-700"></div>
                    <p class="mt-6 text-xl text-gray-400 title-font">${game.message}</p>
                `;
            } else if (game.isLLMLoaded) {
                const startButton = createElement('button', `metal-button w-2/3 py-4 text-2xl title-font mt-12`, 'INITIATE CHALLENGE');
                startButton.onclick = getTopics;
                welcomeContent.append(
                    createElement('p', 'text-xl text-gray-300 mb-8 text-center', 'The Machine Core is fully charged. Hit the throttle to begin your climb to $1000 points.'),
                    startButton
                );
            }
            return welcomeContent;
        }

        function renderPhase2() {
            if (game.isLoading) {
                return createElement('div', 'flex flex-col items-center justify-center h-full p-8', `
                    <div class="animate-pulse rounded-full h-12 w-12 bg-electric-cyan"></div>
                    <p class="mt-6 text-xl text-gray-400 title-font">ANALYZING POTENTIAL TARGETS...</p>
                `);
            }
            
            const topicContent = createElement('div', 'flex flex-col items-center justify-center h-full space-y-8 p-8');
            
            const topicHeader = createElement('h3', 'text-3xl font-bold title-font text-electric-cyan text-center', 'SELECT NEXT TARGET');
            topicContent.appendChild(topicHeader);

            const topicButtons = createElement('div', 'w-full space-y-6');
            game.topics.forEach((topic) => {
                const button = createElement('button', 'metal-button w-full py-4 text-xl', topic.toUpperCase());
                button.onclick = () => inferenceLLM(topic);
                topicButtons.appendChild(button);
            });
            topicContent.appendChild(topicButtons);

            return topicContent;
        }

        function renderPhase3() {
            if (game.isLoading || !game.questionData) {
                return createElement('div', 'flex flex-col items-center justify-center h-full p-8', `
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-electric-cyan border-gray-700"></div>
                    <p class="mt-6 text-xl text-gray-400 title-font">GENERATING PAYLOAD...</p>
                `);
            }
            
            const questionData = game.questionData;
            const allAnswers = [...questionData.wrongAnswers, questionData.correctAnswer].sort(() => Math.random() - 0.5);
            
            const qContent = createElement('div', 'flex flex-col h-full');
            
            // Question Panel
            const qPanel = createElement('div', 'p-6 bg-gray-800 rounded-lg border-2 border-electric-blue mb-8 shadow-xl');
            qPanel.innerHTML = `
                <p class="text-sm font-semibold text-electric-cyan mb-2">TARGET TOPIC: ${game.currentTopic.toUpperCase()}</p>
                <p class="text-3xl font-bold text-gray-100 title-font">${questionData.question}</p>
            `;
            qContent.appendChild(qPanel);

            // Answer Buttons
            const answersDiv = createElement('div', 'space-y-4 flex-1');
            allAnswers.forEach((answer) => {
                let classes = 'w-full text-left p-4 rounded-md border-2 text-gray-100 font-medium transition duration-200';
                const isSelected = game.selectedAnswer === answer;
                const isCorrect = answer === questionData.correctAnswer;
                const isDisabled = game.selectedAnswer !== null;

                if (isDisabled) {
                    if (isCorrect) {
                        classes += ' bg-green-700 border-green-500 shadow-lg shadow-green-700/50'; // Correct
                    } else if (isSelected) {
                        classes += ' bg-red-800 border-red-600 shadow-lg shadow-red-800/50'; // Wrong selection
                    } else {
                        classes += ' bg-gray-700 border-gray-600 opacity-50'; // Faded
                    }
                } else {
                    classes += ' bg-gray-700 border-gray-500 hover:bg-gray-600'; // Active
                }

                const button = createElement('button', classes, answer);
                button.disabled = isDisabled;
                button.onclick = () => handleAnswerSelect(answer);
                answersDiv.appendChild(button);
            });
            qContent.appendChild(answersDiv);
            
            return qContent;
        }
        
        function renderWinScreen() {
            const winContent = createElement('div', 'flex flex-col items-center justify-center h-full text-center bg-gray-800 p-10 rounded-xl shadow-2xl');
            winContent.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-electric-cyan mb-6 speed-icon">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/>
                </svg>
                <h3 class="text-5xl font-extrabold title-font text-electric-cyan">SYSTEM OVERRIDE!</h3>
                <p class="text-2xl text-gray-300 mt-4">MACHINE DEFEATED. FINAL SCORE: $${game.score}</p>
            `;
            const restartButton = createElement('button', 'metal-button w-2/3 py-4 text-xl mt-8 bg-red-600 hover:bg-red-700', 'REBOOT CHALLENGE');
            restartButton.onclick = () => window.location.reload();
            winContent.appendChild(restartButton);
            return winContent;
        }


        /**
         * Main render function: builds the entire UI based on game state.
         */
        function renderGame() {
            if (game.score >= 1000) {
                appContainer.innerHTML = '';
                appContainer.appendChild(renderWinScreen());
                return;
            }

            // Game Panels Structure
            appContainer.innerHTML = `
                <div class="flex w-full metal-card min-h-[700px]">
                    <!-- LEFT PANEL: Conductor Info -->
                    <div class="w-1/5 bg-gray-900 text-white p-4 hidden md:flex flex-col items-center justify-between border-r-4 border-electric-cyan">
                        <div class="text-center space-y-3">
                            <h3 class="text-xl font-bold border-b pb-2 border-gray-700 mb-4 title-font text-electric-cyan">A.I. CONDUCTOR</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-electric-cyan speed-icon">
                                <path d="M12 2a10 10 0 0 0 0 20 10 10 0 0 0 0-20z"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><path d="M9 10h.01"/><path d="M15 10h.01"/>
                            </svg>
                            <div class="text-sm font-mono mt-4 p-2 bg-gray-700 rounded-lg border border-electric-cyan/50">
                                <p>STATUS: ${game.isLoading ? 'LOADING' : 'IDLE'}</p>
                                <p>PHASE: ${game.phase}</p>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-500">
                            <p>Lux Aeterna!</p>
                        </div>
                    </div>

                    <!-- CENTER PANEL: Game Interaction -->
                    <div id="center-panel" class="flex-1 p-6 flex flex-col justify-between">
                        <h2 class="text-4xl font-extrabold text-white mb-4 text-center title-font">
                           ${game.phase > 1 ? 'LIVE CHALLENGE INTERFACE' : 'BOOT SEQUENCE'}
                        </h2>
                        
                        <!-- Game Message Panel -->
                        <div class="p-4 mb-6 text-center rounded-sm font-semibold shadow-md bg-electric-blue/20 text-electric-cyan border border-electric-blue">
                            ${game.message}
                        </div>

                        <!-- Dynamic Phase Content Placeholder -->
                        <div id="dynamic-content" class="flex-1"></div>
                    </div>

                    <!-- RIGHT PANEL: Player Info -->
                    <div class="w-1/5 bg-gray-900 text-white p-4 hidden md:flex flex-col items-center justify-between border-l-4 border-electric-cyan">
                        <div class="text-center space-y-3">
                            <h3 class="text-xl font-bold border-b pb-2 border-gray-700 mb-4 title-font text-electric-cyan">PILOT DATA</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-yellow-400 speed-icon">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                            </svg>
                            <div class="mt-4 p-3 bg-gray-700 rounded-lg border border-yellow-400/50 shadow-xl">
                                <p class="text-sm font-mono text-gray-400">SCORE REGISTER</p>
                                <p class="text-4xl font-extrabold text-yellow-400 title-font">$${game.score}</p>
                                <p class="text-xs text-gray-200">TARGET: $1000</p>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-500">
                            <p>Chase that light!</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Render phase-specific content
            const dynamicContent = document.getElementById('dynamic-content');
            dynamicContent.innerHTML = '';
            
            let contentElement;
            switch (game.phase) {
                case 1:
                    contentElement = renderPhase1();
                    break;
                case 2:
                    contentElement = renderPhase2();
                    break;
                case 3:
                    contentElement = renderPhase3();
                    break;
                default:
                    contentElement = createElement('div', 'text-center p-8 text-red-500', 'UNKNOWN GAME STATE');
            }
            dynamicContent.appendChild(contentElement);
        }

        // Initialize the game when the window loads
        window.onload = initializeLLM;
    </script>
</body>
</html>